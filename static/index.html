<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHL Assessment Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      .shl-blue {
        background-color: #004b87;
      } /* Official SHL Brand Color */
      .shl-blue-light {
        background-color: #0099ce;
      }
      .glass-panel {
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      tr:nth-child(even) {
        background-color: #f8fafc;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800 font-sans min-h-screen">
    <nav class="shl-blue text-white shadow-lg sticky top-0 z-50">
      <div
        class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"
      >
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-layer-group text-2xl text-blue-300"></i>
          <div>
            <h1 class="text-xl font-bold tracking-wide">SHL Architect</h1>
            <p class="text-xs text-blue-200 uppercase tracking-wider">
              AI Recommendation Engine
            </p>
          </div>
        </div>
        <div class="flex gap-4">
          <a
            href="/docs"
            target="_blank"
            class="text-sm hover:text-blue-200 transition"
            ><i class="fa-solid fa-book"></i> API Docs</a
          >
          <span
            class="text-xs bg-blue-600/50 px-3 py-1 rounded border border-blue-400/30"
            >v2.1 Production</span
          >
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">
      <div class="glass-panel rounded-xl p-8 mb-8 border border-slate-200">
        <label class="block text-sm font-bold text-slate-500 uppercase mb-2">
          <i class="fa-solid fa-magnifying-glass mr-1"></i> Job Description /
          Query
        </label>
        <div class="flex flex-col md:flex-row gap-4">
          <textarea
            id="query"
            rows="2"
            placeholder="e.g., 'Looking for a Senior Java Developer who can also lead a team and has good communication skills.'"
            class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none transition text-lg"
          ></textarea>
          <button
            onclick="getRecs()"
            class="shl-blue hover:bg-blue-800 text-white font-bold px-8 py-3 rounded-lg shadow-md transition transform active:scale-95 whitespace-nowrap flex items-center justify-center gap-2"
          >
            Analyze & Recommend
          </button>
        </div>
        <div class="mt-4 flex flex-wrap gap-2 text-sm text-slate-500">
          <span class="font-semibold">Quick Fill:</span>
          <button
            class="hover:text-blue-600 underline decoration-dotted"
            onclick="fillQuery('Graduate accountant with numerical skills')"
          >
            Graduate Accountant
          </button>
          <span class="text-slate-300">|</span>
          <button
            class="hover:text-blue-600 underline decoration-dotted"
            onclick="fillQuery('Java Tech Lead with agile experience')"
          >
            Tech Lead
          </button>
          <span class="text-slate-300">|</span>
          <button
            class="hover:text-blue-600 underline decoration-dotted"
            onclick="fillQuery('Sales Executive driven by targets')"
          >
            Sales
          </button>
        </div>
      </div>

      <div id="loading" class="hidden py-12 text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-blue-600 mx-auto mb-4"
        ></div>
        <p class="text-slate-600 font-medium animate-pulse">
          Running Semantic Search (RAG)...
        </p>
        <p class="text-xs text-slate-400 mt-1">
          Balancing Technical & Behavioral assessments
        </p>
      </div>

      <div id="results-area" class="hidden fade-in">
        <div class="flex justify-between items-end mb-4">
          <h2 class="text-2xl font-bold text-slate-800">
            Recommended Assessments
          </h2>
          <button
            onclick="downloadCSV()"
            class="text-sm bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-file-csv mr-2 text-green-600"></i> Download
            CSV
          </button>
        </div>

        <div
          class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
        >
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr
                  class="bg-slate-100 text-slate-600 text-sm uppercase tracking-wider border-b border-slate-200"
                >
                  <th class="p-4 font-bold w-16">Rank</th>
                  <th class="p-4 font-bold">Assessment Name</th>
                  <th class="p-4 font-bold">Type</th>
                  <th class="p-4 font-bold w-24">Match</th>
                  <th class="p-4 font-bold w-24">Duration</th>
                  <th class="p-4 font-bold w-32">Action</th>
                </tr>
              </thead>
              <tbody
                id="table-body"
                class="text-sm text-slate-700 divide-y divide-slate-100"
              ></tbody>
            </table>
          </div>
        </div>

        <p class="mt-4 text-xs text-center text-slate-400">
          * Rankings based on cosine similarity of 'all-MiniLM-L6-v2'
          embeddings.
        </p>
      </div>
    </main>

    <script>
      let currentResults = [];

      function fillQuery(text) {
        document.getElementById("query").value = text;
      }

      async function getRecs() {
        const query = document.getElementById("query").value.trim();
        if (!query) return alert("Please enter a job description or query.");

        // UI Reset
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("results-area").classList.add("hidden");
        document.getElementById("table-body").innerHTML = "";

        try {
          const res = await fetch("/recommend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });

          if (!res.ok) throw new Error("API Error");

          const data = await res.json();
          currentResults = data.recommended_assessments;
          renderTable(currentResults);
        } catch (e) {
          alert("Connection Failed. Ensure backend is running: " + e.message);
        } finally {
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("results-area").classList.remove("hidden");
        }
      }

      function renderTable(items) {
        const tbody = document.getElementById("table-body");

        if (items.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="p-6 text-center text-slate-500">No relevant assessments found.</td></tr>';
          return;
        }

        items.forEach((item, index) => {
          // Formatting
          const scoreClass =
            item.match_score > 75
              ? "text-green-600 bg-green-50"
              : item.match_score > 50
              ? "text-blue-600 bg-blue-50"
              : "text-yellow-600 bg-yellow-50";
          const types = item.test_type
            .map(
              (t) =>
                `<span class="inline-block bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded border border-slate-200 mr-1 mb-1">${t}</span>`
            )
            .join("");

          const row = `
                <tr class="hover:bg-blue-50/30 transition group">
                    <td class="p-4 font-bold text-slate-400">#${index + 1}</td>
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${item.name}</div>
                        <div class="text-xs text-slate-500 mt-1 truncate max-w-md" title="${
                          item.description
                        }">${item.description}</div>
                    </td>
                    <td class="p-4 align-top">${types}</td>
                    <td class="p-4">
                        <span class="${scoreClass} px-2 py-1 rounded font-bold text-xs">${
            item.match_score
          }%</span>
                    </td>
                    <td class="p-4 text-slate-500">
                        <i class="fa-regular fa-clock mr-1"></i>${
                          item.duration
                        }m
                    </td>
                    <td class="p-4">
                        <a href="${
                          item.url
                        }" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold text-xs border border-blue-200 hover:border-blue-600 px-3 py-1.5 rounded transition bg-white">
                            View <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                        </a>
                    </td>
                </tr>`;
          tbody.innerHTML += row;
        });
      }

      function downloadCSV() {
        if (!currentResults.length) return;

        let csv = "Rank,Assessment Name,Match Score,Type,Duration,URL\n";
        currentResults.forEach((item, index) => {
          const types = item.test_type.join("; ");
          csv += `${index + 1},"${item.name}",${item.match_score},"${types}",${
            item.duration
          },"${item.url}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("hidden", "");
        a.setAttribute("href", url);
        a.setAttribute("download", "shl_recommendations.csv");
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    </script>
  </body>
</html>
